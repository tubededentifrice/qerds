{% extends "base.html" %}
{#
  Preuve de Refus (Proof of Refusal) PDF Template

  Generated at EVT_REFUSED event per specs/implementation/30-lifecycle-and-evidence.md

  Required context variables:
  - delivery_id: Delivery reference (ID)
  - refusal_timestamp: Timestamp of refusal

  Optional context variables:
  - deposit_timestamp: Timestamp of deposit (from evidence)
  - sender_name: Sender name
  - sender_email: Sender email
  - sender_address: Sender address
  - sender_organization: Sender organization
  - recipient_name: Recipient name (revealed after refusal per CPCE)
  - recipient_email: Recipient email
  - recipient_organization: Recipient organization
  - recipient_address: Recipient address
  - subject: Subject line of the delivery
  - content_hash: SHA-256 hash/digest of content
  - hash_algorithm: Algorithm used for content hash (default: SHA-256)
  - seal_id: Provider seal ID
  - signature_algorithm: Signature algorithm (default: Ed25519)
  - provider_name: Provider name (default: QERDS)
  - timestamp_authority: Timestamp authority info dict
  - verification_url: Verification URL for the proof
  - proof_id: Unique proof identifier for verification

  Provided by base context:
  - is_qualified: Whether this is a qualified service
  - qualification_mode: "qualified" or "non_qualified"
  - generated_at: Document generation timestamp
  - _: Translation function
  - lang: Current language code
#}

{% block title %}{{ _('pdf.refusal_proof_title') }} - {{ delivery_id }}{% endblock %}

{% block page_header %}{{ _('pdf.refusal_proof_title') }} - {{ delivery_id }}{% endblock %}

{% block body_class %}proof-refusal{% endblock %}

{% block content %}
<h1 class="document-title">{{ _('pdf.refusal_proof_title') }}</h1>
<p class="document-subtitle">
    {% if is_qualified %}{{ _('pdf.lre_subtitle_qualified') }}{% else %}{{ _('pdf.lre_subtitle_dev') }}{% endif %}
</p>

{# Delivery Reference Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.delivery_reference') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.delivery_id') }}</span>
            <span class="info-value text-mono">{{ delivery_id }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">{{ _('pdf.deposit_date') }}</span>
            <span class="info-value">{{ deposit_timestamp|format_datetime if deposit_timestamp else _('pdf.not_available') }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">{{ _('pdf.refusal_date') }}</span>
            <span class="info-value">{{ refusal_timestamp|format_datetime if refusal_timestamp else _('pdf.not_available') }}</span>
        </div>
        {% if subject %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.subject') }}</span>
            <span class="info-value">{{ subject }}</span>
        </div>
        {% endif %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.status') }}</span>
            <span class="info-value">
                <span class="status-badge status-badge--error">
                    {{ _('pdf.status_refused') }}
                </span>
            </span>
        </div>
    </div>
</section>

{# Sender Information Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.sender_info') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.name') }}</span>
            <span class="info-value">{{ sender_name|default(_('pdf.not_specified')) }}</span>
        </div>
        {% if sender_organization %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.organization') }}</span>
            <span class="info-value">{{ sender_organization }}</span>
        </div>
        {% endif %}
        {% if sender_email %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.email') }}</span>
            <span class="info-value">{{ sender_email }}</span>
        </div>
        {% endif %}
        {% if sender_address %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.address') }}</span>
            <span class="info-value">{{ sender_address }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Recipient Information Section (revealed after refusal per CPCE) #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.recipient_info') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.name') }}</span>
            <span class="info-value">{{ recipient_name|default(_('pdf.not_specified')) }}</span>
        </div>
        {% if recipient_organization %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.organization') }}</span>
            <span class="info-value">{{ recipient_organization }}</span>
        </div>
        {% endif %}
        {% if recipient_email %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.email') }}</span>
            <span class="info-value">{{ recipient_email }}</span>
        </div>
        {% endif %}
        {% if recipient_address %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.address') }}</span>
            <span class="info-value">{{ recipient_address }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Content Hash/Digest Section #}
{% if content_hash %}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.content_integrity') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.algorithm') }}</span>
            <span class="info-value">{{ hash_algorithm|default('SHA-256') }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">{{ _('pdf.fingerprint') }}</span>
            <span class="info-value crypto-data">{{ content_hash }}</span>
        </div>
    </div>
</section>
{% endif %}

{# Provider Seal Section #}
<section class="seal-section {% if is_qualified %}seal-qualified{% else %}seal-non-qualified{% endif %} avoid-break">
    <h3 class="seal-title">
        {% if is_qualified %}
        {{ _('pdf.seal_qualified') }}
        {% else %}
        {{ _('pdf.seal_non_qualified') }}
        {% endif %}
    </h3>
    <dl class="seal-details">
        <dt>{{ _('pdf.provider') }}</dt>
        <dd>{{ provider_name|default('QERDS') }}</dd>

        <dt>{{ _('pdf.signature_algorithm') }}</dt>
        <dd>{{ signature_algorithm|default('Ed25519') }}</dd>

        <dt>{{ _('pdf.refusal_timestamp') }}</dt>
        <dd>{{ refusal_timestamp|format_datetime if refusal_timestamp else generated_at|format_datetime }}</dd>

        {% if seal_id %}
        <dt>{{ _('pdf.seal_id') }}</dt>
        <dd class="crypto-data">{{ seal_id }}</dd>
        {% endif %}
    </dl>
</section>

{# Timestamp Authority Information Section #}
{% if timestamp_authority %}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.timestamp_authority') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.timestamp_authority_name') }}</span>
            <span class="info-value">{{ timestamp_authority.name|default(_('pdf.not_available')) }}</span>
        </div>
        {% if timestamp_authority.policy_oid %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.policy_oid') }}</span>
            <span class="info-value text-mono">{{ timestamp_authority.policy_oid }}</span>
        </div>
        {% endif %}
        {% if timestamp_authority.serial_number %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.serial_number') }}</span>
            <span class="info-value text-mono">{{ timestamp_authority.serial_number }}</span>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

{# Verification Instructions Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.verification_section') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.proof_id') }}</span>
            <span class="info-value text-mono">{{ proof_id|default(delivery_id) }}</span>
        </div>
        {% if verification_url %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.verification_url') }}</span>
            <span class="info-value">{{ verification_url }}</span>
        </div>
        {% endif %}
    </div>
    <p class="text-small text-muted mt-2">
        {{ _('pdf.verification_portal_note') }}
    </p>
</section>

{# Qualification Label Section #}
<section class="info-section avoid-break mt-4">
    <div class="qualification-notice {% if is_qualified %}qualification-notice--qualified{% else %}qualification-notice--dev{% endif %}">
        {% if is_qualified %}
        <p><strong>{{ _('pdf.qualified_service_eidas') }}</strong></p>
        <p class="text-small">
            {{ _('pdf.qualified_refusal_notice') }}
        </p>
        {% else %}
        <p><strong>{{ _('pdf.dev_mode_title') }}</strong></p>
        <p class="text-small">
            {{ _('pdf.dev_mode_warning') }}
        </p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block verification_info %}
{{ _('pdf.verification_info') }} {{ proof_id|default(delivery_id) }}{% if verification_url %} ({{ verification_url }}){% endif %}.
{% endblock %}
