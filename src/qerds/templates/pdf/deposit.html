{% extends "base.html" %}
{#
  Preuve de Depot (Proof of Deposit) PDF Template

  Generated at EVT_DEPOSITED event per specs/implementation/30-lifecycle-and-evidence.md
  Covers: REQ-B01, REQ-F01, REQ-F07

  Required context variables:
  - delivery_id: Delivery reference (ID)
  - deposit_timestamp: Timestamp of deposit (from evidence)
  - sender_name: Sender name
  - sender_email: Sender email (optional)
  - sender_address: Sender address (optional)
  - sender_organization: Sender organization (optional)
  - recipient_name: Recipient name
  - recipient_email: Recipient email
  - subject: Subject line of the delivery
  - content_hash: SHA-256 hash/digest of content
  - seal_id: Provider seal ID (optional)
  - seal_timestamp: Seal timestamp (optional)
  - tsa_info: Timestamp authority info (optional)
  - verification_url: Verification URL for the proof
  - proof_id: Unique proof identifier for verification

  Provided by base context:
  - is_qualified: Whether this is a qualified service
  - qualification_mode: "qualified" or "non_qualified"
  - generated_at: Document generation timestamp
  - _: Translation function
  - lang: Current language code
#}

{% block title %}{{ _('pdf.deposit_proof_title') }} - {{ delivery_id }}{% endblock %}

{% block page_header %}{{ _('pdf.deposit_proof_title') }} - {{ delivery_id }}{% endblock %}

{% block body_class %}proof-deposit{% endblock %}

{% block content %}
<h1 class="document-title">{{ _('pdf.deposit_proof_title') }}</h1>
<p class="document-subtitle">
    {% if is_qualified %}{{ _('pdf.lre_subtitle_qualified') }}{% else %}{{ _('pdf.lre_subtitle_dev') }}{% endif %}
</p>

{# Delivery Reference Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.delivery_reference') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.delivery_id') }}</span>
            <span class="info-value text-mono">{{ delivery_id }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">{{ _('pdf.deposit_date_time') }}</span>
            <span class="info-value">{{ deposit_timestamp|format_datetime if deposit_timestamp else _('pdf.not_available') }}</span>
        </div>
        {% if subject %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.subject') }}</span>
            <span class="info-value">{{ subject }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Sender Information Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.sender_info') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.identity') }}</span>
            <span class="info-value">{{ sender_name|default(_('pdf.not_specified')) }}</span>
        </div>
        {% if sender_organization %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.organization') }}</span>
            <span class="info-value">{{ sender_organization }}</span>
        </div>
        {% endif %}
        {% if sender_email %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.email_address') }}</span>
            <span class="info-value">{{ sender_email }}</span>
        </div>
        {% endif %}
        {% if sender_address %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.address') }}</span>
            <span class="info-value">{{ sender_address }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Recipient Information Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.recipient_info') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.identity') }}</span>
            <span class="info-value">{{ recipient_name|default(_('pdf.not_specified')) }}</span>
        </div>
        {% if recipient_organization %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.organization') }}</span>
            <span class="info-value">{{ recipient_organization }}</span>
        </div>
        {% endif %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.email_address') }}</span>
            <span class="info-value">{{ recipient_email|default(_('pdf.not_specified')) }}</span>
        </div>
    </div>
</section>

{# Content Integrity Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.content_integrity') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.digital_fingerprint') }}</span>
            <span class="info-value crypto-data">{{ content_hash|default(_('pdf.not_available')) }}</span>
        </div>
        {% if content_info %}
        {% if content_info.document_count %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.document_count') }}</span>
            <span class="info-value">{{ content_info.document_count }}</span>
        </div>
        {% endif %}
        {% if content_info.total_size %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.total_size') }}</span>
            <span class="info-value">{{ content_info.total_size }}</span>
        </div>
        {% endif %}
        {% endif %}
    </div>
</section>

{# Provider Seal Section #}
<section class="seal-section {% if is_qualified %}seal-qualified{% else %}seal-non-qualified{% endif %} avoid-break">
    <h3 class="seal-title">
        {% if is_qualified %}
        {{ _('pdf.seal_qualified') }}
        {% else %}
        {{ _('pdf.seal_non_qualified') }}
        {% endif %}
    </h3>
    <dl class="seal-details">
        <dt>{{ _('pdf.signature_algorithm') }}</dt>
        <dd>{{ signature_algorithm|default('Ed25519') }}</dd>

        <dt>{{ _('pdf.seal_timestamp') }}</dt>
        <dd>{{ seal_timestamp|format_datetime if seal_timestamp else deposit_timestamp|format_datetime if deposit_timestamp else generated_at|format_datetime }}</dd>

        {% if seal_id %}
        <dt>{{ _('pdf.seal_id') }}</dt>
        <dd class="text-mono">{{ seal_id }}</dd>
        {% endif %}
    </dl>
</section>

{# Timestamp Authority Info Section #}
{% if tsa_info or is_qualified %}
<section class="info-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.timestamp_authority') }}</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">{{ _('pdf.timestamp_service') }}</span>
            <span class="info-value">
                {% if tsa_info and tsa_info.name %}
                    {{ tsa_info.name }}
                {% elif is_qualified %}
                    {{ _('pdf.timestamp_qualified') }}
                {% else %}
                    {{ _('pdf.timestamp_dev') }}
                {% endif %}
            </span>
        </div>
        {% if tsa_info and tsa_info.policy_oid %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.policy_oid') }}</span>
            <span class="info-value text-mono">{{ tsa_info.policy_oid }}</span>
        </div>
        {% endif %}
        {% if tsa_info and tsa_info.token_id %}
        <div class="info-row">
            <span class="info-label">{{ _('pdf.token_id') }}</span>
            <span class="info-value text-mono">{{ tsa_info.token_id }}</span>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

{# Verification Instructions Section #}
<section class="verification-section avoid-break">
    <h2 class="info-section-title">{{ _('pdf.verification_section') }}</h2>
    <div class="verification-content">
        <p class="verification-instruction">
            {{ _('pdf.verification_instruction') }}
        </p>
        <div class="info-grid">
            {% if proof_id %}
            <div class="info-row">
                <span class="info-label">{{ _('pdf.proof_id') }}</span>
                <span class="info-value text-mono">{{ proof_id }}</span>
            </div>
            {% endif %}
            <div class="info-row">
                <span class="info-label">{{ _('pdf.delivery_reference') }}</span>
                <span class="info-value text-mono">{{ delivery_id }}</span>
            </div>
            {% if verification_url %}
            <div class="info-row">
                <span class="info-label">{{ _('pdf.verification_url') }}</span>
                <span class="info-value">{{ verification_url }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</section>

{# Qualification Label Section #}
<section class="qualification-section avoid-break">
    {% if is_qualified %}
    <div class="qualification-notice qualification-notice--qualified">
        <h3>{{ _('pdf.qualified_service_title') }}</h3>
        <p>
            {{ _('pdf.qualified_deposit_notice') }}
        </p>
        <p>
            {{ _('pdf.qualified_deposit_attestation') }}
        </p>
    </div>
    {% else %}
    <div class="qualification-notice qualification-notice--dev">
        <h3>{{ _('pdf.dev_mode_title') }}</h3>
        <p>
            {{ _('pdf.dev_mode_warning') }}
        </p>
        <p>
            {{ _('pdf.dev_mode_recommendation') }}
        </p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block verification_info %}
{{ _('pdf.verification_info') }} {{ delivery_id }}{% if proof_id %} ({{ proof_id }}){% endif %}.
{% endblock %}
