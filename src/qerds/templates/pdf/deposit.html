{% extends "base.html" %}
{#
  Preuve de Depot (Proof of Deposit) PDF Template

  Generated at EVT_DEPOSITED event per specs/implementation/30-lifecycle-and-evidence.md
  Covers: REQ-B01, REQ-F01, REQ-F07

  Required context variables:
  - delivery_id: Delivery reference (ID)
  - deposit_timestamp: Timestamp of deposit (from evidence)
  - sender_name: Sender name
  - sender_email: Sender email (optional)
  - sender_address: Sender address (optional)
  - sender_organization: Sender organization (optional)
  - recipient_name: Recipient name
  - recipient_email: Recipient email
  - subject: Subject line of the delivery
  - content_hash: SHA-256 hash/digest of content
  - seal_id: Provider seal ID (optional)
  - seal_timestamp: Seal timestamp (optional)
  - tsa_info: Timestamp authority info (optional)
  - verification_url: Verification URL for the proof
  - proof_id: Unique proof identifier for verification

  Provided by base context:
  - is_qualified: Whether this is a qualified service
  - qualification_mode: "qualified" or "non_qualified"
  - generated_at: Document generation timestamp
#}

{% block title %}Preuve de Depot - {{ delivery_id }}{% endblock %}

{% block page_header %}Preuve de Depot - {{ delivery_id }}{% endblock %}

{% block body_class %}proof-deposit{% endblock %}

{% block content %}
<h1 class="document-title">Preuve de Depot</h1>
<p class="document-subtitle">
    Lettre Recommandee Electronique {% if is_qualified %}Qualifiee{% else %}(Mode developpement){% endif %}
</p>

{# Delivery Reference Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">Reference de l'envoi</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Identifiant de l'envoi</span>
            <span class="info-value text-mono">{{ delivery_id }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Date et heure de depot</span>
            <span class="info-value">{{ deposit_timestamp|format_datetime if deposit_timestamp else 'Non disponible' }}</span>
        </div>
        {% if subject %}
        <div class="info-row">
            <span class="info-label">Objet</span>
            <span class="info-value">{{ subject }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Sender Information Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">Expediteur</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Identite</span>
            <span class="info-value">{{ sender_name|default('Non specifie') }}</span>
        </div>
        {% if sender_organization %}
        <div class="info-row">
            <span class="info-label">Organisation</span>
            <span class="info-value">{{ sender_organization }}</span>
        </div>
        {% endif %}
        {% if sender_email %}
        <div class="info-row">
            <span class="info-label">Adresse e-mail</span>
            <span class="info-value">{{ sender_email }}</span>
        </div>
        {% endif %}
        {% if sender_address %}
        <div class="info-row">
            <span class="info-label">Adresse</span>
            <span class="info-value">{{ sender_address }}</span>
        </div>
        {% endif %}
    </div>
</section>

{# Recipient Information Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">Destinataire</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Identite</span>
            <span class="info-value">{{ recipient_name|default('Non specifie') }}</span>
        </div>
        {% if recipient_organization %}
        <div class="info-row">
            <span class="info-label">Organisation</span>
            <span class="info-value">{{ recipient_organization }}</span>
        </div>
        {% endif %}
        <div class="info-row">
            <span class="info-label">Adresse e-mail</span>
            <span class="info-value">{{ recipient_email|default('Non specifie') }}</span>
        </div>
    </div>
</section>

{# Content Integrity Section #}
<section class="info-section avoid-break">
    <h2 class="info-section-title">Integrite du contenu</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Empreinte numerique (SHA-256)</span>
            <span class="info-value crypto-data">{{ content_hash|default('Non disponible') }}</span>
        </div>
        {% if content_info %}
        {% if content_info.document_count %}
        <div class="info-row">
            <span class="info-label">Nombre de documents</span>
            <span class="info-value">{{ content_info.document_count }}</span>
        </div>
        {% endif %}
        {% if content_info.total_size %}
        <div class="info-row">
            <span class="info-label">Taille totale</span>
            <span class="info-value">{{ content_info.total_size }}</span>
        </div>
        {% endif %}
        {% endif %}
    </div>
</section>

{# Provider Seal Section #}
<section class="seal-section {% if is_qualified %}seal-qualified{% else %}seal-non-qualified{% endif %} avoid-break">
    <h3 class="seal-title">
        {% if is_qualified %}
        Sceau electronique qualifie du prestataire
        {% else %}
        Sceau electronique (non qualifie - developpement)
        {% endif %}
    </h3>
    <dl class="seal-details">
        <dt>Algorithme de signature</dt>
        <dd>{{ signature_algorithm|default('Ed25519') }}</dd>

        <dt>Horodatage du sceau</dt>
        <dd>{{ seal_timestamp|format_datetime if seal_timestamp else deposit_timestamp|format_datetime if deposit_timestamp else generated_at|format_datetime }}</dd>

        {% if seal_id %}
        <dt>Identifiant du sceau</dt>
        <dd class="text-mono">{{ seal_id }}</dd>
        {% endif %}
    </dl>
</section>

{# Timestamp Authority Info Section #}
{% if tsa_info or is_qualified %}
<section class="info-section avoid-break">
    <h2 class="info-section-title">Autorite d'horodatage</h2>
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Service d'horodatage</span>
            <span class="info-value">
                {% if tsa_info and tsa_info.name %}
                    {{ tsa_info.name }}
                {% elif is_qualified %}
                    Service d'horodatage qualifie eIDAS
                {% else %}
                    Service d'horodatage (developpement)
                {% endif %}
            </span>
        </div>
        {% if tsa_info and tsa_info.policy_oid %}
        <div class="info-row">
            <span class="info-label">Politique (OID)</span>
            <span class="info-value text-mono">{{ tsa_info.policy_oid }}</span>
        </div>
        {% endif %}
        {% if tsa_info and tsa_info.token_id %}
        <div class="info-row">
            <span class="info-label">Identifiant du jeton</span>
            <span class="info-value text-mono">{{ tsa_info.token_id }}</span>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

{# Verification Instructions Section #}
<section class="verification-section avoid-break">
    <h2 class="info-section-title">Verification de la preuve</h2>
    <div class="verification-content">
        <p class="verification-instruction">
            Pour verifier l'authenticite de cette preuve de depot, utilisez le service
            de verification QERDS avec les informations suivantes :
        </p>
        <div class="info-grid">
            {% if proof_id %}
            <div class="info-row">
                <span class="info-label">Identifiant de la preuve</span>
                <span class="info-value text-mono">{{ proof_id }}</span>
            </div>
            {% endif %}
            <div class="info-row">
                <span class="info-label">Reference de l'envoi</span>
                <span class="info-value text-mono">{{ delivery_id }}</span>
            </div>
            {% if verification_url %}
            <div class="info-row">
                <span class="info-label">URL de verification</span>
                <span class="info-value">{{ verification_url }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</section>

{# Qualification Label Section #}
<section class="qualification-section avoid-break">
    {% if is_qualified %}
    <div class="qualification-notice qualification-notice--qualified">
        <h3>Service de Lettre Recommandee Electronique Qualifie</h3>
        <p>
            Cette preuve de depot est emise par un prestataire de services de confiance
            qualifie conformement au reglement (UE) n 910/2014 (eIDAS) et au Code des
            Postes et des Communications Electroniques (CPCE).
        </p>
        <p>
            Elle atteste que l'envoi reference ci-dessus a ete depose aupres du
            prestataire a la date et l'heure indiquees, et que son contenu a ete
            scelle de maniere integre.
        </p>
    </div>
    {% else %}
    <div class="qualification-notice qualification-notice--dev">
        <h3>Mode developpement - Service non qualifie</h3>
        <p>
            <strong>ATTENTION :</strong> Cette preuve a ete generee en mode
            developpement. Elle n'a pas de valeur juridique et ne constitue pas
            une preuve qualifiee au sens du reglement eIDAS.
        </p>
        <p>
            Pour des envois ayant valeur legale, utilisez un service de Lettre
            Recommandee Electronique Qualifiee (LREQ).
        </p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block verification_info %}
Pour verifier l'authenticite de cette preuve de depot, utilisez le service de
verification QERDS avec l'identifiant {{ delivery_id }}{% if proof_id %} et la
reference de preuve {{ proof_id }}{% endif %}.
{% endblock %}
