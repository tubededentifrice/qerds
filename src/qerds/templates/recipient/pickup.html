{% extends "base.html" %}

{% block title %}{{ _('pickup.title') }}{% endblock %}

{% block nav %}{% endblock %}

{% block main %}
<div class="pickup-hero">
    <div class="pickup-hero-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
    </div>
    <h1 class="pickup-title">{{ _('pickup.received_title') }}</h1>
    <p class="pickup-description">
        {{ _('pickup.received_description') }}
    </p>
</div>

<div class="container">
    <article class="pickup-card">
        <header class="pickup-card-header">
            <div class="pickup-card-header-content">
                <h2 class="pickup-card-title">
                    {{ _('pickup.delivery_info') }}
                </h2>
                <p class="pickup-card-reference">
                    {{ _('delivery.reference') }} : <code class="pickup-reference-code">{{ delivery.id[:8] }}</code>
                </p>
            </div>
        </header>

        <div class="pickup-card-body">
            <div class="delivery-info-list">
                {# CRITICAL: Sender identity is hidden before accept/refuse (REQ-F03) #}
                <div class="delivery-info-item">
                    <span class="delivery-info-label">{{ _('delivery.sender') }}</span>
                    <div class="redacted-info">
                        <svg viewBox="0 0 20 20" fill="currentColor" class="redacted-info-icon">
                            <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z"/>
                            <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"/>
                        </svg>
                        <span>{{ _('delivery.sender_hidden') }}</span>
                    </div>
                    <p class="delivery-info-note">
                        {{ _('delivery.sender_hidden_note') }}
                    </p>
                </div>

                <div class="delivery-info-item">
                    <span class="delivery-info-label">{{ _('delivery.subject') }}</span>
                    <span class="delivery-info-value">{{ delivery.subject or _('delivery.subject_not_specified') }}</span>
                </div>

                <div class="delivery-info-item">
                    <span class="delivery-info-label">{{ _('delivery.deposit_date') }}</span>
                    <span class="delivery-info-value">{{ delivery.deposited_at_formatted }}</span>
                </div>

                {# Deadline with countdown - shows prominently per REQ-F04 (15-day window) #}
                <div class="delivery-info-item">
                    <span class="delivery-info-label">{{ _('delivery.withdrawal_deadline') }}</span>
                    <div class="pickup-deadline">
                        <span class="pickup-deadline-date">
                            {{ delivery.expires_at_formatted }}
                        </span>
                        {% if delivery.expires_at_iso %}
                        <div class="pickup-countdown"
                             id="deadline-countdown"
                             data-deadline="{{ delivery.expires_at_iso }}"
                             data-days-label="{{ _('pickup.days') }}"
                             data-hours-label="{{ _('pickup.hours') }}"
                             data-minutes-label="{{ _('pickup.minutes') }}"
                             data-expired-label="{{ _('pickup.deadline_expired') }}">
                            <span class="pickup-countdown-loading">{{ _('pickup.calculating') }}...</span>
                        </div>
                        {% endif %}
                    </div>
                    <p class="delivery-info-note">
                        {{ _('delivery.withdrawal_deadline_note') }}
                    </p>
                </div>

                {# Content metadata - showing file type and size #}
                <div class="delivery-info-item">
                    <span class="delivery-info-label">{{ _('delivery.attachment') }}</span>
                    {% if delivery.content_objects and delivery.content_objects|length > 0 %}
                    <ul class="pickup-attachments-list">
                        {% for content in delivery.content_objects %}
                        <li class="pickup-attachment-item">
                            <svg viewBox="0 0 20 20" fill="currentColor" class="pickup-attachment-icon pickup-attachment-icon--{{ content.mime_type_class or 'default' }}">
                                {% if content.mime_type == 'application/pdf' %}
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                                {% else %}
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"/>
                                {% endif %}
                            </svg>
                            <span class="pickup-attachment-name">{{ content.display_name or _('delivery.document') }}</span>
                            <span class="pickup-attachment-meta">({{ content.size_formatted or content.size_bytes }})</span>
                        </li>
                        {% endfor %}
                    </ul>
                    <p class="pickup-attachments-summary">
                        {{ _('pickup.total_attachments', count=delivery.content_objects|length) }} - {{ delivery.total_size_formatted or delivery.content_size }}
                    </p>
                    {% else %}
                    <div class="pickup-attachment-item">
                        <svg viewBox="0 0 20 20" fill="currentColor" class="pickup-attachment-icon pickup-attachment-icon--pdf">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                        </svg>
                        <span class="pickup-attachment-name">{{ _('delivery.pdf_document') }}</span>
                        <span class="pickup-attachment-meta">({{ delivery.content_size or '1.2 Mo' }})</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="pickup-notice">
                <svg viewBox="0 0 20 20" fill="currentColor" class="pickup-notice-icon">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                </svg>
                <div class="pickup-notice-content">
                    <strong>{{ _('delivery.important') }}</strong><br>
                    {{ _('delivery.accept_refuse_note') }}
                </div>
            </div>
        </div>

        <footer class="pickup-card-footer">
            {% if not user %}
            {# Authentication wall - user must identify before accept/refuse #}
            <div class="alert alert--warning pickup-auth-alert">
                <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>
                </svg>
                <div>
                    <strong>{{ _('auth.identification_required') }}</strong><br>
                    {{ _('auth.identification_required_note') }}
                </div>
            </div>
            <a href="/pickup/{{ delivery.id }}/auth" class="btn btn--primary btn--block btn--lg pickup-auth-button">
                <svg viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                {{ _('auth.identify_with_franceconnect') }}
            </a>
            {% else %}
            {# Authenticated user - show accept/refuse actions #}
            <div class="pickup-actions" id="pickup-actions">
                <form action="/pickup/{{ delivery.id }}/accept"
                      method="POST"
                      class="pickup-action-form"
                      id="accept-form">
                    {# Consumer consent checkbox for LRE (REQ-F06) #}
                    {% if requires_consent %}
                    <label class="pickup-consent-checkbox">
                        <input type="checkbox" name="confirm_consent" value="true" required>
                        <span class="pickup-consent-label">{{ _('pickup.consent_checkbox') }}</span>
                    </label>
                    {% endif %}
                    <button type="submit"
                            class="btn btn--success btn--block btn--lg pickup-action-btn"
                            id="accept-btn"
                            data-confirm="{{ _('pickup.confirm_accept') }}">
                        <span class="btn-icon">
                            <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                        </span>
                        <span class="btn-text">{{ _('delivery.accept_and_download') }}</span>
                        <span class="btn-loading" hidden>
                            <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                <path d="M12 2a10 10 0 0110 10" stroke-linecap="round"/>
                            </svg>
                            {{ _('pickup.processing') }}
                        </span>
                    </button>
                </form>
                <form action="/pickup/{{ delivery.id }}/refuse"
                      method="POST"
                      class="pickup-action-form"
                      id="refuse-form">
                    <button type="submit"
                            class="btn btn--outline btn--block btn--danger-outline pickup-action-btn"
                            id="refuse-btn"
                            data-confirm="{{ _('pickup.confirm_refuse') }}">
                        <span class="btn-icon">
                            <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                        </span>
                        <span class="btn-text">{{ _('delivery.refuse') }}</span>
                        <span class="btn-loading" hidden>
                            <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                <path d="M12 2a10 10 0 0110 10" stroke-linecap="round"/>
                            </svg>
                            {{ _('pickup.processing') }}
                        </span>
                    </button>
                </form>
            </div>
            {% endif %}
        </footer>
    </article>

    <p class="pickup-compliance-note">
        {{ _('pickup.eidas_compliance_note') }}
        <a href="/help/recipient">{{ _('pickup.learn_more') }}</a>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    // Deadline countdown functionality
    var countdownEl = document.getElementById('deadline-countdown');
    if (countdownEl) {
        var deadline = new Date(countdownEl.dataset.deadline);
        var daysLabel = countdownEl.dataset.daysLabel || 'days';
        var hoursLabel = countdownEl.dataset.hoursLabel || 'hours';
        var minutesLabel = countdownEl.dataset.minutesLabel || 'min';
        var expiredLabel = countdownEl.dataset.expiredLabel || 'Expired';

        function updateCountdown() {
            var now = new Date();
            var diff = deadline - now;

            if (diff <= 0) {
                countdownEl.innerHTML = '<span class="pickup-countdown-expired">' + expiredLabel + '</span>';
                countdownEl.classList.add('pickup-countdown--expired');
                return;
            }

            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            var html = '<div class="pickup-countdown-units">';
            if (days > 0) {
                html += '<span class="pickup-countdown-unit"><strong>' + days + '</strong> ' + daysLabel + '</span>';
            }
            html += '<span class="pickup-countdown-unit"><strong>' + hours + '</strong> ' + hoursLabel + '</span>';
            html += '<span class="pickup-countdown-unit"><strong>' + minutes + '</strong> ' + minutesLabel + '</span>';
            html += '</div>';

            countdownEl.innerHTML = html;

            // Add urgency class if less than 3 days
            if (days < 3) {
                countdownEl.classList.add('pickup-countdown--urgent');
            }
        }

        updateCountdown();
        setInterval(updateCountdown, 60000); // Update every minute
    }

    // Form submission handling with loading states
    var forms = document.querySelectorAll('.pickup-action-form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            var btn = form.querySelector('.pickup-action-btn');
            var confirmMsg = btn.dataset.confirm;

            // Confirmation dialog
            if (confirmMsg && !confirm(confirmMsg)) {
                e.preventDefault();
                return;
            }

            // Disable all action buttons
            var allBtns = document.querySelectorAll('.pickup-action-btn');
            allBtns.forEach(function(b) {
                b.disabled = true;
            });

            // Show loading state on clicked button
            btn.classList.add('btn--loading');
            var btnIcon = btn.querySelector('.btn-icon');
            var btnText = btn.querySelector('.btn-text');
            var btnLoading = btn.querySelector('.btn-loading');

            if (btnIcon) btnIcon.hidden = true;
            if (btnText) btnText.hidden = true;
            if (btnLoading) btnLoading.hidden = false;
        });
    });
})();
</script>
{% endblock %}
