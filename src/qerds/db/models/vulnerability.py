"""Vulnerability finding model for security vulnerability tracking.

Covers: REQ-H09 (vulnerability management evidence)

This module provides tracking for individual security findings from vulnerability
scans, penetration tests, or manual security reviews. It complements the
VulnerabilityEvidence model (which stores artifacts/reports) by tracking
the actual findings for remediation workflow.
"""

from __future__ import annotations

import enum
import uuid  # noqa: TC003 - required at runtime for SQLAlchemy type resolution

from sqlalchemy import Enum, ForeignKey, Index, String, Text
from sqlalchemy.dialects.postgresql import JSONB, UUID
from sqlalchemy.orm import Mapped, mapped_column

from qerds.db.models.base import (
    Base,
    OptionalTimestampTZ,
    TimestampTZ,
    UUIDPrimaryKey,
)


class FindingSource(enum.Enum):
    """Source of a vulnerability finding.

    Values:
        TRIVY: Automated Trivy container/image scan
        GRYPE: Automated Grype container/image scan
        PENTEST: Annual penetration test
        MANUAL: Manual security review or audit
        DEPENDENCY_CHECK: Dependency vulnerability scan (e.g., OWASP Dependency-Check)
        SAST: Static Application Security Testing
        DAST: Dynamic Application Security Testing
    """

    TRIVY = "trivy"
    GRYPE = "grype"
    PENTEST = "pentest"
    MANUAL = "manual"
    DEPENDENCY_CHECK = "dependency_check"
    SAST = "sast"
    DAST = "dast"


class FindingSeverity(enum.Enum):
    """Severity level of a vulnerability finding.

    Based on CVSS v3 severity ratings.

    Values:
        CRITICAL: CVSS >= 9.0
        HIGH: CVSS 7.0-8.9
        MEDIUM: CVSS 4.0-6.9
        LOW: CVSS 0.1-3.9
        INFORMATIONAL: No CVSS score / informational only
    """

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFORMATIONAL = "informational"


class FindingStatus(enum.Enum):
    """Status of a vulnerability finding in the remediation workflow.

    Values:
        OPEN: Finding is new and unaddressed
        IN_PROGRESS: Remediation work is underway
        REMEDIATED: Finding has been fixed
        EXCEPTED: Risk accepted with documented exception
        FALSE_POSITIVE: Finding was determined to be invalid
    """

    OPEN = "open"
    IN_PROGRESS = "in_progress"
    REMEDIATED = "remediated"
    EXCEPTED = "excepted"
    FALSE_POSITIVE = "false_positive"


class VulnerabilityFinding(Base):
    """Individual security vulnerability finding for remediation tracking.

    This model tracks discrete vulnerability findings from various sources
    (automated scans, penetration tests, manual reviews) through their
    remediation lifecycle. It provides audit-ready evidence of vulnerability
    management activities per REQ-H09.

    Unlike VulnerabilityEvidence (which stores report artifacts), this model
    tracks individual findings for workflow and status management.
    """

    __tablename__ = "vulnerability_findings"

    finding_id: Mapped[UUIDPrimaryKey]
    created_at: Mapped[TimestampTZ]

    # Source classification
    source: Mapped[FindingSource] = mapped_column(
        Enum(FindingSource, name="finding_source", create_constraint=True),
        nullable=False,
    )

    # External finding identifier from the source tool (e.g., CVE-2024-1234, TRIVY-001)
    external_finding_id: Mapped[str | None] = mapped_column(String(255), nullable=True)

    # Severity classification
    severity: Mapped[FindingSeverity] = mapped_column(
        Enum(FindingSeverity, name="finding_severity", create_constraint=True),
        nullable=False,
    )

    # Workflow status
    status: Mapped[FindingStatus] = mapped_column(
        Enum(FindingStatus, name="finding_status", create_constraint=True),
        nullable=False,
        default=FindingStatus.OPEN,
    )

    # Finding details
    title: Mapped[str] = mapped_column(String(500), nullable=False)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)

    # What is affected (e.g., "api:latest", "postgresql:15", "src/qerds/api/")
    affected_component: Mapped[str] = mapped_column(String(500), nullable=False)

    # Timeline tracking
    discovered_at: Mapped[TimestampTZ]
    remediated_at: Mapped[OptionalTimestampTZ]

    # Remediation tracking
    remediation_notes: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Exception workflow (for risk acceptance)
    exception_approved_by: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("admin_users.admin_user_id", ondelete="SET NULL"),
        nullable=True,
    )
    exception_reason: Mapped[str | None] = mapped_column(Text, nullable=True)
    exception_expires: Mapped[OptionalTimestampTZ]

    # Link to source artifact (e.g., the scan report that produced this finding)
    source_evidence_id: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("vulnerability_evidence.vuln_evidence_id", ondelete="SET NULL"),
        nullable=True,
    )

    # CVSS score if available (0.0-10.0)
    cvss_score: Mapped[float | None] = mapped_column(nullable=True)

    # CVE identifier if applicable
    cve_id: Mapped[str | None] = mapped_column(String(20), nullable=True)

    # Additional metadata from the scanner/source
    extra_metadata: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    __table_args__ = (
        Index("ix_vuln_findings_source", "source"),
        Index("ix_vuln_findings_severity", "severity"),
        Index("ix_vuln_findings_status", "status"),
        Index("ix_vuln_findings_discovered_at", "discovered_at"),
        Index("ix_vuln_findings_affected_component", "affected_component"),
        Index("ix_vuln_findings_cve_id", "cve_id"),
        Index("ix_vuln_findings_external_id", "source", "external_finding_id"),
        Index("ix_vuln_findings_source_evidence", "source_evidence_id"),
    )
