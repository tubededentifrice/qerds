# QERDS Development Environment
# Run with: docker compose up
#
# Services:
#   - postgres: PostgreSQL 16 database
#   - minio: S3-compatible object storage
#   - mailpit: Email testing (SMTP + Web UI)
#   - mocks: UI mockups server
#
# Optional profiles:
#   - interop: Enable with: docker compose --profile interop up
#     - domibus: AS4 Message Service Handler (ETSI EN 319 522 interoperability)
#     - domibus-mysql: MySQL 5.7 database for Domibus (AS4 gateway only)
#     - smp: phoss SMP for BDXR/Peppol metadata publishing
#     - smp-postgres: PostgreSQL 16 database for phoss SMP
#   - security-tools: Enable with: docker compose --profile security-tools up
#     - registry: Internal OCI registry for air-gapped tooling
#
# Placeholder services (commented until Python project exists):
#   - qerds-api: FastAPI application
#   - qerds-worker: Background job runner
#   - qerds-trust: Signing/timestamping service
#
# Architecture Note (REQ-I01 - Backend/Frontend Separation):
# The qerds-api service contains both backend logic and frontend assets
# in a single image. The separation is enforced at the code level:
#
#   - Certified Core (Backend): src/qerds/services/, trust/, db/, worker/
#   - Frontend Assets: src/qerds/templates/, static/, locales/
#   - API Layer (Boundary): src/qerds/api/
#
# Frontend assets are served by FastAPI's StaticFiles middleware. If needed
# for compliance or operational reasons, the architecture supports separation
# into distinct containers (API + nginx for static assets).
#
# See: specs/implementation/95-architecture-boundaries.md

services:
  # --------------------------------------------------------------------------
  # Core Infrastructure Services
  # --------------------------------------------------------------------------

  # PostgreSQL 16 - Primary database for state, evidence indexing, audit metadata
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: qerds
      POSTGRES_USER: qerds
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-qerds_dev_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Bind to localhost only per CLAUDE.md (not public IP 217.182.203.57)
    # Using 5434 to avoid conflict with other projects using 5432
    ports:
      - "127.0.0.1:5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qerds -d qerds"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # MinIO - S3-compatible object storage for content blobs and evidence bundles
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-qerds_minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-qerds_minio_secret}
    volumes:
      - minio_data:/data
    # Bind to localhost only per CLAUDE.md
    ports:
      - "127.0.0.1:9000:9000"   # API
      - "127.0.0.1:9001:9001"   # Console
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Mailpit - Email testing (captures all outbound mail)
  mailpit:
    image: axllent/mailpit:latest
    environment:
      # Accept any SMTP auth for dev convenience
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    # Bind to localhost only per CLAUDE.md
    ports:
      - "127.0.0.1:8025:8025"   # Web UI
      - "127.0.0.1:1025:1025"   # SMTP
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # AS4 Interoperability Services (REQ-C04 - ETSI EN 319 522)
  # Enable with: docker compose --profile interop up
  # See: docs/deployment/as4-gateway.md for setup instructions
  # --------------------------------------------------------------------------

  # MySQL 5.7 - Database for Domibus AS4 gateway (separate from QERDS PostgreSQL)
  # Domibus requires MySQL; cannot share PostgreSQL with qerds-api
  # NOTE: Using MySQL 5.7 for compatibility with FIWARE Domibus image (Domibus 4.0)
  # which uses an older MySQL JDBC driver that doesn't support MySQL 8's caching_sha2_password
  domibus-mysql:
    image: mysql:5.7
    profiles: ["interop"]
    environment:
      MYSQL_ROOT_PASSWORD: ${DOMIBUS_MYSQL_ROOT_PASSWORD:-domibus_root_dev}
      MYSQL_DATABASE: domibus
      MYSQL_USER: domibus
      MYSQL_PASSWORD: ${DOMIBUS_DB_PASSWORD:-domibus_dev_password}
    volumes:
      - domibus_mysql_data:/var/lib/mysql
      # Database initialization scripts (Domibus 4.0 schema)
      - ./domibus/sql:/docker-entrypoint-initdb.d:ro
    # Internal only - no host port needed, accessed by domibus container
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DOMIBUS_MYSQL_ROOT_PASSWORD:-domibus_root_dev}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Domibus AS4 Message Service Handler - ETSI EN 319 522 interoperability
  # Reference: https://ec.europa.eu/digital-building-blocks/sites/display/DIGITAL/Domibus
  domibus:
    image: fiware/domibus-tomcat:latest
    profiles: ["interop"]
    environment:
      # Database connection (to domibus-mysql)
      DB_HOST: domibus-mysql
      DB_PORT: "3306"
      DB_NAME: domibus
      DB_USER: domibus
      DB_PASS: ${DOMIBUS_DB_PASSWORD:-domibus_dev_password}
      # Java memory settings
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    volumes:
      # Configuration files
      - ./domibus/config/domibus.properties:/opt/domibus/conf/domibus/domibus.properties:ro
      - ./domibus/config/logback.xml:/opt/domibus/conf/domibus/logback.xml:ro
      # Persistent data
      - domibus_data:/opt/domibus/data
      - domibus_logs:/opt/domibus/logs
    # Bind to localhost only per CLAUDE.md
    ports:
      - "127.0.0.1:8180:8080"   # Admin Console + WS Plugin
    depends_on:
      domibus-mysql:
        condition: service_healthy
    healthcheck:
      # Check Tomcat is responding (Domibus app deployment takes time)
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # SMP/BDXR Metadata Publishing (REQ-C04 - ETSI EN 319 522)
  # Enable with: docker compose --profile interop up
  # See: smp/README.md for setup instructions
  # --------------------------------------------------------------------------

  # PostgreSQL 16 - Database for phoss SMP (separate from QERDS PostgreSQL)
  # phoss SMP supports PostgreSQL 13/14+ with Flyway migrations
  smp-postgres:
    image: postgres:16-alpine
    profiles: ["interop"]
    environment:
      POSTGRES_DB: smp
      POSTGRES_USER: smp
      POSTGRES_PASSWORD: ${SMP_DB_PASSWORD:-smp_dev_password}
    volumes:
      - smp_postgres_data:/var/lib/postgresql/data
    # Internal only - no host port needed, accessed by smp container
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smp -d smp"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # phoss SMP - BDXR/Peppol Service Metadata Publisher
  # Reference: https://github.com/phax/phoss-smp
  # Supports: Peppol SMP 1.x, OASIS BDXR SMP 1.0/2.0
  smp:
    image: phelger/phoss-smp-sql:latest
    profiles: ["interop"]
    environment:
      # Configuration file location
      CONFIG_FILE: /config/application.properties
      # Java memory settings
      JAVA_OPTS: "-Xms256m -Xmx512m"
      # Pass database password to application.properties
      SMP_DB_PASSWORD: ${SMP_DB_PASSWORD:-smp_dev_password}
      SMP_ADMIN_PASSWORD: ${SMP_ADMIN_PASSWORD:-smp_admin_dev}
    volumes:
      # Configuration files
      - ./smp/config/application.properties:/config/application.properties:ro
      - ./smp/config/logback.xml:/config/logback.xml:ro
      # Persistent data
      - smp_data:/home/git/conf
      - smp_logs:/var/log/smp
    # Bind to localhost only per CLAUDE.md
    ports:
      - "127.0.0.1:8280:8080"   # SMP REST API + Admin UI
    depends_on:
      smp-postgres:
        condition: service_healthy
    healthcheck:
      # Check SMP status endpoint is responding
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Development Tools
  # --------------------------------------------------------------------------

  # UI Mocks Server - Serves UI mockups for design review
  mocks:
    build:
      context: .
      dockerfile: docker/Dockerfile.mocks
    ports:
      - "5000:5000"
    volumes:
      # Mount for live reload during development
      - ./mocks/templates:/app/templates:ro
      - ./mocks/static:/app/static:ro
      - ./mocks/app.py:/app/app.py:ro
    environment:
      - FLASK_DEBUG=1
      - FLASK_ENV=development
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # Security Tools (optional profile)
  # Enable with: docker compose --profile security-tools up
  # --------------------------------------------------------------------------

  # Internal OCI registry (for air-gapped tooling like Trivy DB mirroring)
  registry-auth-init:
    image: httpd:2.4-alpine
    profiles: ["security-tools"]
    environment:
      - QERDS_REGISTRY_USER
      - QERDS_REGISTRY_PASSWORD
    command:
      - sh
      - -ec
      - |
        if [ -z "${QERDS_REGISTRY_USER:-}" ] || [ -z "${QERDS_REGISTRY_PASSWORD:-}" ]; then
          echo "Missing QERDS_REGISTRY_USER/QERDS_REGISTRY_PASSWORD (see .env.example)" >&2
          exit 1
        fi
        if [ ! -f /auth/htpasswd ]; then
          htpasswd -Bbn "${QERDS_REGISTRY_USER}" "${QERDS_REGISTRY_PASSWORD}" > /auth/htpasswd
          chmod 0600 /auth/htpasswd
        fi
    volumes:
      - registry_auth:/auth
    restart: "no"

  registry:
    image: registry:2
    profiles: ["security-tools"]
    depends_on:
      registry-auth-init:
        condition: service_completed_successfully
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: qerds-registry
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
    volumes:
      - registry_data:/var/lib/registry
      - registry_auth:/auth:ro
    # No host port published by default. Access from inside the compose network:
    #   http://registry:5000

  # --------------------------------------------------------------------------
  # QERDS Application Services (PLACEHOLDERS)
  # Uncomment and configure once Python project structure exists
  # --------------------------------------------------------------------------

  # qerds-api:
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.api
  #   environment:
  #     # Database
  #     DATABASE_URL: postgresql://qerds:${POSTGRES_PASSWORD:-qerds_dev_password}@postgres:5432/qerds
  #     # MinIO/S3
  #     S3_ENDPOINT: http://minio:9000
  #     S3_ACCESS_KEY: ${MINIO_ROOT_USER:-qerds_minio}
  #     S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-qerds_minio_secret}
  #     S3_BUCKET: qerds-evidence
  #     # SMTP (Mailpit in dev)
  #     SMTP_HOST: mailpit
  #     SMTP_PORT: 1025
  #     # Trust service
  #     TRUST_SERVICE_URL: http://qerds-trust:8080
  #   ports:
  #     - "127.0.0.1:8000:8000"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     minio:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 30s
  #   restart: unless-stopped

  qerds-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    command: ["python", "-m", "qerds.worker"]
    environment:
      # Database (worker uses async driver)
      DATABASE_URL: postgresql://qerds:${POSTGRES_PASSWORD:-qerds_dev_password}@postgres:5432/qerds
      # Worker configuration
      WORKER_POLL_INTERVAL: "1.0"
      WORKER_QUEUES: "default"
      WORKER_STALE_THRESHOLD: "600"
      WORKER_SHUTDOWN_TIMEOUT: "30"
      WORKER_POOL_SIZE: "5"
      LOG_LEVEL: INFO
      # MinIO/S3
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-qerds_minio}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-qerds_minio_secret}
      S3_BUCKET: qerds-evidence
      # SMTP (Mailpit in dev)
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      SMTP_FROM_ADDRESS: noreply@qerds.local
      SMTP_FROM_NAME: QERDS
      # Application
      BASE_URL: http://localhost:8000
      PROVIDER_NAME: QERDS
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      mailpit:
        condition: service_healthy
    restart: unless-stopped

  # qerds-trust:
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.trust
  #   environment:
  #     # Trust service mode: non_qualified (dev) or qualified (prod with HSM)
  #     TRUST_MODE: non_qualified
  #     # Key storage path (for non_qualified mode only)
  #     KEY_STORAGE_PATH: /keys
  #   volumes:
  #     - trust_keys:/keys
  #   ports:
  #     - "127.0.0.1:8080:8080"
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s
  #   restart: unless-stopped

volumes:
  # Core infrastructure
  postgres_data:
  minio_data:
  # AS4 interoperability (Domibus)
  domibus_mysql_data:
  domibus_data:
  domibus_logs:
  # SMP/BDXR metadata publishing (phoss SMP)
  smp_postgres_data:
  smp_data:
  smp_logs:
  # Security tools (optional profile)
  registry_data:
  registry_auth:
  # QERDS application (uncomment when enabling services)
  # trust_keys:

networks:
  default:
    name: qerds_network
