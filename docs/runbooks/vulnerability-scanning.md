# Vulnerability Scanning Runbook

**Covers**: REQ-D05 (Quarterly vulnerability scanning), REQ-H09 (Vulnerability management evidence)

This runbook documents the quarterly vulnerability scanning procedures for QERDS platform operators. All scans and findings MUST be recorded in the platform for audit compliance.

## Table of Contents

1. [Overview](#overview)
2. [Scanning Requirements](#scanning-requirements)
3. [Pre-Scan Preparation](#pre-scan-preparation)
4. [Scan Execution](#scan-execution)
5. [Results Processing](#results-processing)
6. [Remediation Workflow](#remediation-workflow)
7. [Recording Evidence](#recording-evidence)
8. [Automation Scripts](#automation-scripts)

---

## Overview

Vulnerability scanning is a regulatory requirement for QERDS providers. Per Implementing Regulation 2025/1944 and ETSI EN 319 401, the provider MUST perform vulnerability scanning at least quarterly and maintain audit-ready evidence of scanning activities and remediation.

**Key Compliance Requirements**:
- Quarterly minimum scan frequency (REQ-D05)
- All system components in scope
- Documented remediation workflow
- Audit-ready evidence of all activities (REQ-H09)

---

## Scanning Requirements

### Frequency

| Scan Type | Minimum Frequency | Recommended |
|-----------|-------------------|-------------|
| Container image scanning | Quarterly | Weekly |
| Dependency scanning | Quarterly | On each release |
| Infrastructure scanning | Quarterly | Monthly |
| Web application scanning | Quarterly | Monthly |

### Scope

All system components MUST be included in quarterly scans:

- **Container images**: All Docker images used in production
- **Dependencies**: Python packages, JavaScript packages, system packages
- **Infrastructure**: Network services, exposed ports, configurations
- **Web application**: API endpoints, authentication flows, input validation

### Tool Recommendations

The following tools are recommended for self-hosted vulnerability scanning:

| Category | Tool | Notes |
|----------|------|-------|
| Container/Image | Trivy | Air-gap mode supported; tracks DB version for reproducibility |
| Container/Image | Grype (alternative) | Anchore-based; good container support |
| Python dependencies | pip-audit | PyPI advisory database |
| JavaScript dependencies | npm audit | Built-in to npm |
| SBOM generation | Trivy, Syft | CycloneDX/SPDX output |
| Infrastructure | OpenVAS (Greenbone) | Network vulnerability scanner |
| Web application | OWASP ZAP | DAST for web APIs |

---

## Pre-Scan Preparation

### 1. Inventory Current Systems

Before scanning, document the current system inventory:

```bash
# List all container images in use
docker images --format "{{.Repository}}:{{.Tag}}" | sort | uniq

# List running containers
docker compose ps

# Document image digests for reproducibility
docker images --digests --format "{{.Repository}}:{{.Tag}} {{.Digest}}"
```

### 2. Update Scanner Signatures

For Trivy (with air-gap/controlled-update mode):

```bash
# Download latest vulnerability database
trivy image --download-db-only

# Record DB metadata for audit trail
trivy version --format json | jq '.VulnerabilityDB'
```

Example output to record:
```json
{
  "Version": 2,
  "UpdatedAt": "2026-01-20T00:00:00Z",
  "NextUpdate": "2026-01-23T00:00:00Z",
  "DownloadedAt": "2026-01-21T10:30:00Z"
}
```

For pip-audit:

```bash
# Update the vulnerability database
pip-audit --progress-spinner off --cache-dir ~/.cache/pip-audit
```

### 3. Define Scan Targets

Create a scan manifest documenting targets for the quarter:

```yaml
# scan-manifest-2026-Q1.yaml
quarter: 2026-Q1
scan_date: 2026-01-15
targets:
  container_images:
    - qerds-api:latest
    - qerds-worker:latest
    - qerds-trust:latest
    - postgres:16
    - minio:latest
    - mailpit:latest
  python_deps:
    - src/qerds/requirements.txt
    - src/qerds-trust/requirements.txt
  infrastructure:
    - internal services (docker network)
    - exposed services (API gateway)
  web_application:
    - https://qerds.example.com/api/
```

---

## Scan Execution

### Container Image Scanning

Scan all container images using Trivy:

```bash
#!/bin/bash
# scan-containers.sh

QUARTER="2026-Q1"
OUTPUT_DIR="./scans/${QUARTER}/containers"
mkdir -p "${OUTPUT_DIR}"

# List of images to scan
IMAGES=(
    "qerds-api:latest"
    "qerds-worker:latest"
    "qerds-trust:latest"
    "postgres:16"
    "minio:latest"
)

for IMAGE in "${IMAGES[@]}"; do
    SAFE_NAME=$(echo "${IMAGE}" | tr ':/' '_')
    echo "Scanning ${IMAGE}..."

    trivy image \
        --format json \
        --output "${OUTPUT_DIR}/${SAFE_NAME}.json" \
        --severity CRITICAL,HIGH,MEDIUM,LOW \
        "${IMAGE}"

    # Also generate human-readable report
    trivy image \
        --format table \
        --output "${OUTPUT_DIR}/${SAFE_NAME}.txt" \
        --severity CRITICAL,HIGH,MEDIUM,LOW \
        "${IMAGE}"
done

# Record Trivy version and DB info
trivy version --format json > "${OUTPUT_DIR}/trivy-version.json"
```

### Dependency Scanning

**Python dependencies (pip-audit)**:

```bash
#!/bin/bash
# scan-python-deps.sh

QUARTER="2026-Q1"
OUTPUT_DIR="./scans/${QUARTER}/dependencies"
mkdir -p "${OUTPUT_DIR}"

# Scan from within the container for accurate results
docker compose exec qerds-api pip-audit \
    --format json \
    --output /tmp/pip-audit-api.json

docker compose cp qerds-api:/tmp/pip-audit-api.json \
    "${OUTPUT_DIR}/pip-audit-api.json"

# Generate SBOM alongside audit
docker compose exec qerds-api pip-audit \
    --format cyclonedx-json \
    --output /tmp/sbom-api.json

docker compose cp qerds-api:/tmp/sbom-api.json \
    "${OUTPUT_DIR}/sbom-api.json"
```

**JavaScript dependencies (npm audit)** (if applicable):

```bash
# Run npm audit in the frontend container/directory
npm audit --json > "${OUTPUT_DIR}/npm-audit.json"
```

### Infrastructure Scanning

For network vulnerability scanning with OpenVAS/Greenbone:

```bash
# OpenVAS scan (run from dedicated scanner host)
# Configure target list in OpenVAS web interface
# Export results as XML/PDF for evidence

# Alternative: Use nmap for port scanning baseline
nmap -sV -sC -oX "${OUTPUT_DIR}/nmap-scan.xml" \
    --script vuln \
    127.0.0.1
```

### Web Application Scanning

OWASP ZAP baseline scan:

```bash
# Run ZAP baseline scan against the API
docker run -t owasp/zap2docker-stable zap-baseline.py \
    -t https://qerds.example.com/api/ \
    -J zap-report.json \
    -r zap-report.html

# Copy results
mv zap-report.* "${OUTPUT_DIR}/"
```

---

## Results Processing

### Severity Classification

Use CVSS v3 scoring for consistent severity classification:

| Severity | CVSS Score | Remediation SLA |
|----------|------------|-----------------|
| Critical | 9.0 - 10.0 | 7 days |
| High | 7.0 - 8.9 | 30 days |
| Medium | 4.0 - 6.9 | 90 days |
| Low | 0.1 - 3.9 | Next quarterly cycle |
| Informational | N/A | Best effort |

### Parsing Trivy Results

Extract findings summary from Trivy JSON output:

```bash
# Count findings by severity
jq '[.Results[].Vulnerabilities[] | .Severity] | group_by(.) | map({(.[0]): length}) | add' \
    scans/2026-Q1/containers/qerds-api_latest.json
```

Example output:
```json
{
  "CRITICAL": 0,
  "HIGH": 2,
  "MEDIUM": 5,
  "LOW": 12
}
```

### False Positive Review

Review each finding and document false positives:

1. **Verify exploitability**: Is the vulnerable component actually used/reachable?
2. **Check mitigations**: Are there compensating controls in place?
3. **Document rationale**: Record why a finding is marked as false positive

Create a false positive log:

```json
{
  "finding_id": "CVE-2024-1234",
  "package": "libexample",
  "version": "1.2.3",
  "determination": "false_positive",
  "rationale": "Vulnerable function not called in our codebase. Verified via static analysis.",
  "reviewed_by": "security-team",
  "reviewed_at": "2026-01-16T10:00:00Z"
}
```

### Risk Acceptance Process

For findings that cannot be immediately remediated:

1. Document the business justification
2. Identify compensating controls
3. Set an exception expiration date
4. Obtain approval from security officer
5. Record the exception in the platform

---

## Remediation Workflow

### Patching Priorities by Severity

| Severity | Action Required | Timeline |
|----------|-----------------|----------|
| Critical | Immediate patching or isolation | 7 days max |
| High | Prioritize in current sprint | 30 days max |
| Medium | Schedule for remediation | 90 days max |
| Low | Include in maintenance cycle | Next quarter |

### Remediation Steps

1. **Triage**: Review finding, confirm severity, assign owner
2. **Plan**: Identify fix (upgrade, patch, configuration change)
3. **Test**: Apply fix in staging, verify no regression
4. **Deploy**: Roll out to production
5. **Verify**: Re-scan to confirm remediation
6. **Document**: Record remediation in platform

### Exception Documentation

When risk acceptance is required:

```bash
# Upload exception document to platform
curl -X POST https://qerds.example.com/admin/vulnerability-evidence/remediation \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -F "artifact_type=exception" \
  -F "title=CVE-2024-1234 Risk Acceptance" \
  -F "description=Accepted risk for libexample vulnerability" \
  -F "parent_evidence_id=<source-scan-uuid>" \
  -F "remediation_status=excepted" \
  -F "file=@exception-cve-2024-1234.pdf"
```

---

## Recording Evidence

**CRITICAL**: All scanning activities and findings MUST be recorded in the platform for audit compliance (REQ-H09).

### Upload Vulnerability Scan Report

```bash
curl -X POST https://qerds.example.com/admin/vulnerability-evidence/vuln-scan \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -F "title=Q1 2026 Container Vulnerability Scan" \
  -F "reporting_period=2026-Q1" \
  -F "scan_tool=trivy" \
  -F "scan_tool_version=0.58.0" \
  -F "scan_output_format=trivy_json" \
  -F "trivy_db_digest=sha256:abc123..." \
  -F "trivy_db_tag=2026-01-20" \
  -F 'scan_scope={"images": ["qerds-api:latest", "qerds-worker:latest", "qerds-trust:latest"]}' \
  -F 'findings_summary={"critical": 0, "high": 2, "medium": 5, "low": 12}' \
  -F "file=@scans/2026-Q1/containers/combined-report.json"
```

### Upload SBOM

```bash
curl -X POST https://qerds.example.com/admin/vulnerability-evidence/sbom \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -F "title=Q1 2026 QERDS API SBOM" \
  -F "sbom_format=cyclonedx_json" \
  -F "reporting_period=2026-Q1" \
  -F "description=Software Bill of Materials for qerds-api container" \
  -F "file=@scans/2026-Q1/dependencies/sbom-api.json"
```

### Upload Remediation Plan

```bash
curl -X POST https://qerds.example.com/admin/vulnerability-evidence/remediation \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -F "artifact_type=remediation_plan" \
  -F "title=Q1 2026 Remediation Plan" \
  -F "description=Remediation plan for findings from Q1 2026 vulnerability scan" \
  -F "parent_evidence_id=<vuln-scan-uuid>" \
  -F "remediation_status=in_progress" \
  -F "file=@remediation-plan-2026-q1.pdf"
```

### Track Remediation Progress

Update remediation status as fixes are deployed:

```bash
curl -X PATCH https://qerds.example.com/admin/vulnerability-evidence/<artifact-id>/remediation-status \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "closed",
    "completed_at": "2026-02-15T14:30:00Z"
  }'
```

### View Evidence Summary

```bash
# List all vulnerability evidence for a period
curl "https://qerds.example.com/admin/vulnerability-evidence?reporting_period=2026-Q1" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# Get specific artifact details
curl "https://qerds.example.com/admin/vulnerability-evidence/<artifact-id>" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## Automation Scripts

### Complete Quarterly Scan Script

```bash
#!/bin/bash
# quarterly-vuln-scan.sh
# Run quarterly vulnerability scans and upload results to QERDS

set -euo pipefail

# Configuration
QUARTER="${1:-$(date +%Y-Q$(( ($(date +%-m) - 1) / 3 + 1 )))}"
OUTPUT_DIR="./scans/${QUARTER}"
API_URL="${QERDS_API_URL:-https://qerds.example.com}"
ADMIN_TOKEN="${QERDS_ADMIN_TOKEN:?QERDS_ADMIN_TOKEN must be set}"

echo "Starting quarterly vulnerability scan for ${QUARTER}"
mkdir -p "${OUTPUT_DIR}/containers" "${OUTPUT_DIR}/dependencies"

# Record Trivy DB version for audit trail
echo "Recording Trivy version info..."
TRIVY_VERSION=$(trivy version --format json)
echo "${TRIVY_VERSION}" > "${OUTPUT_DIR}/trivy-version.json"
TRIVY_DB_DIGEST=$(echo "${TRIVY_VERSION}" | jq -r '.VulnerabilityDB.Digest // "unknown"')
TRIVY_DB_TAG=$(echo "${TRIVY_VERSION}" | jq -r '.VulnerabilityDB.UpdatedAt // "unknown"')
TRIVY_TOOL_VERSION=$(echo "${TRIVY_VERSION}" | jq -r '.Version // "unknown"')

# Scan container images
echo "Scanning container images..."
IMAGES=(
    "qerds-api:latest"
    "qerds-worker:latest"
    "qerds-trust:latest"
)

COMBINED_RESULTS=()
for IMAGE in "${IMAGES[@]}"; do
    SAFE_NAME=$(echo "${IMAGE}" | tr ':/' '_')
    echo "  Scanning ${IMAGE}..."

    trivy image \
        --format json \
        --output "${OUTPUT_DIR}/containers/${SAFE_NAME}.json" \
        --severity CRITICAL,HIGH,MEDIUM,LOW \
        "${IMAGE}"

    COMBINED_RESULTS+=("${OUTPUT_DIR}/containers/${SAFE_NAME}.json")
done

# Combine results
echo "Combining scan results..."
jq -s 'add' "${COMBINED_RESULTS[@]}" > "${OUTPUT_DIR}/containers/combined-report.json"

# Calculate findings summary
FINDINGS_SUMMARY=$(jq '[.[].Results[]?.Vulnerabilities[]? | .Severity] | group_by(.) | map({(.[0]): length}) | add // {}' \
    "${OUTPUT_DIR}/containers/combined-report.json")
echo "Findings summary: ${FINDINGS_SUMMARY}"

# Scan Python dependencies
echo "Scanning Python dependencies..."
docker compose exec -T qerds-api pip-audit --format json > "${OUTPUT_DIR}/dependencies/pip-audit.json" || true

# Generate SBOM
echo "Generating SBOM..."
trivy image --format cyclonedx --output "${OUTPUT_DIR}/dependencies/sbom.json" qerds-api:latest

# Upload vulnerability scan report
echo "Uploading scan report to QERDS..."
SCAN_RESPONSE=$(curl -s -X POST "${API_URL}/admin/vulnerability-evidence/vuln-scan" \
  -H "Authorization: Bearer ${ADMIN_TOKEN}" \
  -F "title=${QUARTER} Container Vulnerability Scan" \
  -F "reporting_period=${QUARTER}" \
  -F "scan_tool=trivy" \
  -F "scan_tool_version=${TRIVY_TOOL_VERSION}" \
  -F "scan_output_format=trivy_json" \
  -F "trivy_db_digest=${TRIVY_DB_DIGEST}" \
  -F "trivy_db_tag=${TRIVY_DB_TAG}" \
  -F "scan_scope={\"images\": $(printf '%s\n' "${IMAGES[@]}" | jq -R . | jq -s .)}" \
  -F "findings_summary=${FINDINGS_SUMMARY}" \
  -F "file=@${OUTPUT_DIR}/containers/combined-report.json")

SCAN_ID=$(echo "${SCAN_RESPONSE}" | jq -r '.vuln_evidence_id')
echo "Scan report uploaded: ${SCAN_ID}"

# Upload SBOM
echo "Uploading SBOM..."
curl -s -X POST "${API_URL}/admin/vulnerability-evidence/sbom" \
  -H "Authorization: Bearer ${ADMIN_TOKEN}" \
  -F "title=${QUARTER} QERDS SBOM" \
  -F "sbom_format=cyclonedx_json" \
  -F "reporting_period=${QUARTER}" \
  -F "file=@${OUTPUT_DIR}/dependencies/sbom.json"

echo "Quarterly vulnerability scan complete for ${QUARTER}"
echo "Scan evidence ID: ${SCAN_ID}"
echo "Review findings and create remediation plan as needed."
```

### pip-audit Integration for CI/CD

```bash
#!/bin/bash
# ci-dependency-check.sh
# Run on each build/release to catch new vulnerabilities

set -euo pipefail

echo "Running dependency vulnerability check..."

# Run pip-audit and capture exit code
if pip-audit --strict --format json --output pip-audit-results.json; then
    echo "No vulnerabilities found"
    exit 0
else
    echo "Vulnerabilities detected!"

    # Parse and display summary
    jq -r '.dependencies[] | select(.vulns | length > 0) | "\(.name) \(.version): \(.vulns | length) vulnerabilities"' \
        pip-audit-results.json

    # Check for critical/high severity
    CRITICAL_COUNT=$(jq '[.dependencies[].vulns[] | select(.fix_versions != null)] | length' pip-audit-results.json)

    if [ "${CRITICAL_COUNT}" -gt 0 ]; then
        echo "CRITICAL: ${CRITICAL_COUNT} vulnerabilities with available fixes"
        exit 1
    fi

    echo "WARNING: Vulnerabilities found but none with available fixes"
    exit 0
fi
```

### Trivy Container Scanning for CI/CD

```bash
#!/bin/bash
# ci-container-scan.sh
# Scan container image during build pipeline

set -euo pipefail

IMAGE="${1:?Usage: $0 <image:tag>}"

echo "Scanning container image: ${IMAGE}"

# Scan with severity threshold
trivy image \
    --exit-code 1 \
    --severity CRITICAL,HIGH \
    --ignore-unfixed \
    "${IMAGE}"

echo "Container scan passed: no critical/high vulnerabilities with fixes"
```

---

## Troubleshooting

### Trivy Database Update Fails

If running in air-gapped environment:

1. Download DB on internet-connected machine:
   ```bash
   trivy image --download-db-only --cache-dir ./trivy-cache
   ```
2. Transfer cache directory to air-gapped system
3. Use `--cache-dir` flag when scanning

### pip-audit Fails on Private Packages

Exclude private packages from audit:

```bash
pip-audit --ignore-vuln PYSEC-xxxx --skip-editable
```

### Scan Results Differ Between Runs

Ensure consistent Trivy DB version:
- Record `trivy_db_digest` with each scan
- Use `--db-repository` for controlled updates
- Consider caching DB in container images

### Large Number of False Positives

Review scanner configuration:
- Filter by exploitability (`--ignore-unfixed`)
- Use `.trivyignore` file for documented exceptions
- Adjust severity thresholds appropriately

---

## References

- `specs/requirements.md` - REQ-D05 (Vulnerability scanning), REQ-H09 (Vulnerability management evidence)
- `specs/implementation/90-security-and-ops-controls.md` - Security controls specification
- `src/qerds/services/vulnerability_evidence.py` - Vulnerability evidence service implementation
- `src/qerds/api/routers/admin.py` - Admin API endpoints for evidence upload
- ETSI EN 319 401 - General policy requirements for trust service providers
- Implementing Regulation 2025/1944 - Rules for applying eIDAS for ERDS
