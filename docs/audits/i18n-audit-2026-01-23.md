# i18n String Completeness Audit

**Date**: 2026-01-23
**Auditor**: Coder Agent
**Beads Task**: qerds-bop
**Covers**: SPEC-J01 (Multilingual UI), SPEC-J02 (Locale completeness)

## Executive Summary

Audit of user-facing strings across the QERDS codebase to verify i18n compliance. The audit found that most UI templates are well-internationalized using the `_()` translation function, but identified areas needing remediation in PDF templates, email templates, and API error messages.

**Result**: Locale files updated with 103 new translation keys (496 -> 599 keys per locale) to support full i18n coverage.

## Scope

Areas audited:
- HTML templates (`src/qerds/templates/`)
- Email templates (`src/qerds/templates/email/`)
- PDF templates (`src/qerds/templates/pdf/`)
- API error messages (`src/qerds/api/routers/`)
- Locale files (`src/qerds/locales/en.json`, `src/qerds/locales/fr.json`)

## Findings

### 1. HTML Templates (Web UI)

**Status**: COMPLIANT

All web UI templates properly use the `_()` translation function:
- `base.html` - All strings externalized
- `login.html` - All strings externalized
- `verify.html` - All strings externalized
- `sender/dashboard.html` - All strings externalized
- `recipient/pickup.html` - All strings externalized
- `admin/dashboard.html` - All strings externalized
- `partials/dev_banner.html` - All strings externalized

### 2. Email Templates

**Status**: NON-COMPLIANT (architectural issue)

Email templates use inline language conditionals instead of the i18n system:
```html
{% if lang == 'fr' %}
    Bonjour,
{% else %}
    Hello,
{% endif %}
```

**Files affected**:
- `email/notification.html` - 13 inline conditionals
- `email/reminder.html` - 17 inline conditionals

**Recommendation**: Refactor email templates to use the `_()` translation function consistent with other templates. This requires:
1. Ensuring the translator is passed to email template context
2. Replacing inline conditionals with `{{ _('email.greeting') }}`

**Remediation applied**: Added 20 new email translation keys to support future refactoring.

### 3. PDF Templates

**Status**: NON-COMPLIANT (architectural issue)

PDF templates contain extensive hardcoded French strings:
- `pdf/base.html` - Page header, footer, qualification badges
- `pdf/deposit.html` - All labels and notices
- `pdf/proof_acceptance.html` - All labels and notices
- `pdf/proof_refusal.html` - All labels and notices
- `pdf/proof_negligence.html` - All labels and notices
- `pdf/proof_placeholder.html` - All labels

**Examples of hardcoded strings**:
- "Preuve de Depot"
- "Lettre Recommandee Electronique Qualifiee"
- "Sceau electronique qualifie du prestataire"
- "Ce document a ete genere le"
- "ATTENTION : Ce document a ete genere en mode developpement"

**Remediation applied**: Added 50+ new PDF translation keys to support future refactoring.

### 4. API Error Messages

**Status**: NON-COMPLIANT

API routers contain hardcoded English error messages:
- `pickup.py` - 13 hardcoded messages
- `sender.py` - 11 hardcoded messages
- `auth.py` - 6 hardcoded messages
- `trust.py` - 4 hardcoded messages
- `as4.py` - 1 hardcoded message

**Examples**:
- "Delivery not found"
- "You are not the recipient of this delivery"
- "The acceptance deadline has passed"

**Remediation applied**: Added 18 new error message keys to both locales.

### 5. Locale File Parity

**Status**: COMPLIANT

After remediation:
- `en.json`: 599 keys
- `fr.json`: 599 keys
- Intentional asymmetry: `language.switch_to_fr` (en only), `language.switch_to_en` (fr only)

## Keys Added

### email.* namespace (20 keys)
New keys for email template i18n support:
- `service_tagline`, `greeting`, `notification_body`, `delivery_info_title`
- `reference_label`, `provider_label`, `nature_label`, `nature_value`
- `deadline_title`, `view_delivery_button`, `auth_note`
- `privacy_notice_title`, `privacy_notice_body`
- `footer_compliance`, `footer_auto_email`
- `reminder_title`, `reminder_subtitle`, `action_required`, `reminder_body`
- `days_remaining`, `action_now_button`
- `expiry_warning_title`, `expiry_warning_body`

### pdf.* namespace (50+ keys)
New keys for PDF template i18n support:
- Proof titles: `acceptance_proof_title`, `negligence_proof_title`
- Labels: `delivery_reference`, `deposit_date_time`, `acceptance_date`, `refusal_date`, etc.
- Seal info: `seal_timestamp`, `acceptance_timestamp`, `refusal_timestamp`
- Timestamp authority: `timestamp_authority_name`, `timestamp_service`, `timestamp_qualified`, etc.
- Verification: `verification_section`, `verification_instruction`, `proof_id`, `verification_url`
- Status values: `status_accepted`, `status_refused`, `status_non_claimed`
- Qualified notices: `qualified_service_title`, `qualified_deposit_notice`, `qualified_acceptance_notice`, etc.
- Dev mode: `dev_mode_title`, `dev_mode_warning`, `dev_mode_recommendation`

### errors.* namespace (18 keys)
New keys for API error message i18n support:
- `delivery_not_found`, `not_recipient`, `consent_required`, `deadline_passed`
- `content_after_accept_only`, `not_implemented`
- `oidc_not_configured`, `auth_request_invalid`, `auth_request_expired`
- `auth_token_exchange_failed`, `identity_verification_failed`
- `trust_service_not_initialized`, `invalid_base64`, `hsm_required`
- `hash_invalid`, `hash_mismatch`, `encryption_failed`, `content_required`
- `pdf_generation_failed`, `storage_retrieval_failed`, `decryption_failed`
- `invalid_state`, `ial_insufficient`, `missing_signature_header`

## Test Results

All 62 i18n tests pass:
```
tests/test_i18n.py - 62 passed in 0.06s
```

Tests verify:
- Translation file structure and completeness
- Translation function behavior
- Language detection from requests
- Missing key handling
- All keys have translations in both French and English
- Translation quality (no HTML entities, no whitespace issues)

## Follow-up Work Required

The following issues should be created for future remediation:

### 1. Email Template i18n Refactoring
**Priority**: Medium
**Effort**: 1-2 days

Refactor email templates to use the `_()` translation function:
1. Pass translator to email template rendering context
2. Replace inline `{% if lang == %}` conditionals with `{{ _('key') }}` calls
3. Add tests for email translation

### 2. PDF Template i18n Refactoring
**Priority**: Medium
**Effort**: 2-3 days

Refactor PDF templates to use the `_()` translation function:
1. Ensure WeasyPrint/PDF renderer supports translator context
2. Replace hardcoded French strings with translation keys
3. Add tests for PDF translation in both locales

### 3. API Error Message i18n
**Priority**: Low
**Effort**: 1 day

Refactor API error messages to use translated strings:
1. Create helper function to get localized error messages
2. Update router exception handlers to use localized messages
3. Consider Accept-Language header for API responses

## Compliance Status

| Requirement | Status | Notes |
|-------------|--------|-------|
| SPEC-J01 (Multilingual UI) | PARTIAL | Web UI compliant; PDF/email need refactoring |
| SPEC-J02 (Locale completeness) | COMPLIANT | en/fr parity verified, keys added |

## Conclusion

The locale files are now complete with all necessary translation keys to support full i18n coverage. The web UI is fully internationalized. The email templates, PDF templates, and API error messages have the translation keys ready but require code refactoring to use them.
