"""Tests for vulnerability finding tracking (REQ-H09).

Tests cover:
- VulnerabilityFinding model CRUD operations
- Schema validation
- Status transitions
- Bulk import from Trivy format
- Export for audit pack

Run with: docker compose exec api pytest tests/test_vulnerability.py -xvs
"""

from __future__ import annotations

import uuid
from datetime import UTC, datetime

import pytest
from pydantic import ValidationError

from qerds.api.schemas.admin import (
    VulnerabilityFindingBulkImport,
    VulnerabilityFindingCreate,
    VulnerabilityFindingUpdate,
)

# -----------------------------------------------------------------------------
# Schema Validation Tests
# -----------------------------------------------------------------------------


class TestVulnerabilityFindingCreateSchema:
    """Tests for VulnerabilityFindingCreate schema validation."""

    def test_valid_finding_create(self):
        """Test valid finding creation request passes validation."""
        finding = VulnerabilityFindingCreate(
            source="trivy",
            severity="high",
            title="CVE-2024-1234 in libssl",
            affected_component="api:latest",
            external_finding_id="CVE-2024-1234",
            cvss_score=7.5,
            cve_id="CVE-2024-1234",
        )
        assert finding.source == "trivy"
        assert finding.severity == "high"
        assert finding.cvss_score == 7.5

    def test_invalid_source_fails(self):
        """Test invalid source value fails validation."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingCreate(
                source="invalid_scanner",
                severity="high",
                title="Test finding",
                affected_component="api:latest",
            )

    def test_invalid_severity_fails(self):
        """Test invalid severity value fails validation."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingCreate(
                source="trivy",
                severity="urgent",  # Not valid
                title="Test finding",
                affected_component="api:latest",
            )

    def test_title_too_short_fails(self):
        """Test title shorter than 5 chars fails validation."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingCreate(
                source="trivy",
                severity="high",
                title="CVE",  # Too short
                affected_component="api:latest",
            )

    def test_cvss_score_bounds(self):
        """Test CVSS score must be 0.0-10.0."""
        # Valid scores
        for score in [0.0, 5.5, 10.0]:
            finding = VulnerabilityFindingCreate(
                source="trivy",
                severity="high",
                title="Test finding",
                affected_component="api:latest",
                cvss_score=score,
            )
            assert finding.cvss_score == score

        # Invalid scores
        for score in [-1.0, 10.1, 100.0]:
            with pytest.raises(ValidationError):
                VulnerabilityFindingCreate(
                    source="trivy",
                    severity="high",
                    title="Test finding",
                    affected_component="api:latest",
                    cvss_score=score,
                )

    def test_invalid_cve_id_format_fails(self):
        """Test CVE ID must match CVE-YYYY-NNNNN format."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingCreate(
                source="trivy",
                severity="high",
                title="Test finding",
                affected_component="api:latest",
                cve_id="CVE2024-1234",  # Missing dash
            )

    def test_all_sources_valid(self):
        """Test all source values are accepted."""
        sources = ["trivy", "grype", "pentest", "manual", "dependency_check", "sast", "dast"]
        for source in sources:
            finding = VulnerabilityFindingCreate(
                source=source,
                severity="medium",
                title="Test finding for source",
                affected_component="test:component",
            )
            assert finding.source == source

    def test_all_severities_valid(self):
        """Test all severity values are accepted."""
        severities = ["critical", "high", "medium", "low", "informational"]
        for severity in severities:
            finding = VulnerabilityFindingCreate(
                source="trivy",
                severity=severity,
                title="Test finding for severity",
                affected_component="test:component",
            )
            assert finding.severity == severity


class TestVulnerabilityFindingUpdateSchema:
    """Tests for VulnerabilityFindingUpdate schema validation."""

    def test_valid_status_update(self):
        """Test valid status update passes validation."""
        update = VulnerabilityFindingUpdate(
            status="in_progress",
            remediation_notes="Started working on fix",
        )
        assert update.status == "in_progress"

    def test_invalid_status_fails(self):
        """Test invalid status value fails validation."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingUpdate(status="pending")  # Not valid

    def test_all_statuses_valid(self):
        """Test all status values are accepted."""
        statuses = ["open", "in_progress", "remediated", "excepted", "false_positive"]
        for status in statuses:
            update = VulnerabilityFindingUpdate(status=status)
            assert update.status == status

    def test_exception_with_reason_and_expiry(self):
        """Test exception update with reason and expiry."""
        update = VulnerabilityFindingUpdate(
            status="excepted",
            exception_reason="Low risk in our environment due to network isolation",
            exception_expires=datetime(2025, 12, 31, tzinfo=UTC),
        )
        assert update.exception_reason is not None
        assert update.exception_expires is not None


class TestVulnerabilityFindingBulkImportSchema:
    """Tests for VulnerabilityFindingBulkImport schema validation."""

    def test_valid_bulk_import(self):
        """Test valid bulk import passes validation."""
        import_data = VulnerabilityFindingBulkImport(
            source="trivy",
            affected_component="api:latest",
            findings=[
                {
                    "VulnerabilityID": "CVE-2024-1234",
                    "Severity": "HIGH",
                    "Title": "Test vulnerability",
                },
                {
                    "VulnerabilityID": "CVE-2024-5678",
                    "Severity": "MEDIUM",
                    "Title": "Another vulnerability",
                },
            ],
        )
        assert len(import_data.findings) == 2
        assert import_data.source == "trivy"

    def test_empty_findings_fails(self):
        """Test empty findings list fails validation."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingBulkImport(
                source="trivy",
                affected_component="api:latest",
                findings=[],  # Empty list not allowed
            )

    def test_invalid_import_source_fails(self):
        """Test invalid source for bulk import fails."""
        with pytest.raises(ValidationError):
            VulnerabilityFindingBulkImport(
                source="manual",  # Not allowed for bulk import
                affected_component="api:latest",
                findings=[{"VulnerabilityID": "CVE-2024-1234"}],
            )


# -----------------------------------------------------------------------------
# Model Tests
# -----------------------------------------------------------------------------


class TestVulnerabilityFindingModel:
    """Tests for VulnerabilityFinding SQLAlchemy model."""

    def test_model_enums_exist(self):
        """Test that model enums are properly defined."""
        from qerds.db.models.vulnerability import (
            FindingSeverity,
            FindingSource,
            FindingStatus,
        )

        # Check enum values
        assert FindingSource.TRIVY.value == "trivy"
        assert FindingSource.PENTEST.value == "pentest"

        assert FindingSeverity.CRITICAL.value == "critical"
        assert FindingSeverity.INFORMATIONAL.value == "informational"

        assert FindingStatus.OPEN.value == "open"
        assert FindingStatus.REMEDIATED.value == "remediated"
        assert FindingStatus.EXCEPTED.value == "excepted"

    def test_model_has_required_columns(self):
        """Test that model has all required columns."""
        from qerds.db.models.vulnerability import VulnerabilityFinding

        # Check column names exist
        columns = VulnerabilityFinding.__table__.columns.keys()

        required = [
            "finding_id",
            "created_at",
            "source",
            "external_finding_id",
            "severity",
            "status",
            "title",
            "description",
            "affected_component",
            "discovered_at",
            "remediated_at",
            "remediation_notes",
            "exception_approved_by",
            "exception_reason",
            "exception_expires",
            "source_evidence_id",
            "cvss_score",
            "cve_id",
            "extra_metadata",
        ]

        for col in required:
            assert col in columns, f"Missing column: {col}"

    def test_model_table_name(self):
        """Test model table name."""
        from qerds.db.models.vulnerability import VulnerabilityFinding

        assert VulnerabilityFinding.__tablename__ == "vulnerability_findings"


# -----------------------------------------------------------------------------
# Response Schema Tests
# -----------------------------------------------------------------------------


class TestVulnerabilityFindingResponseSchemas:
    """Tests for response schemas."""

    def test_finding_response_schema(self):
        """Test VulnerabilityFindingResponse schema."""
        from qerds.api.schemas.admin import VulnerabilityFindingResponse

        response = VulnerabilityFindingResponse(
            finding_id=uuid.uuid4(),
            created_at=datetime.now(UTC),
            source="trivy",
            external_finding_id="CVE-2024-1234",
            severity="high",
            status="open",
            title="Test vulnerability",
            description="Test description",
            affected_component="api:latest",
            discovered_at=datetime.now(UTC),
            remediated_at=None,
            remediation_notes=None,
            exception_approved_by=None,
            exception_reason=None,
            exception_expires=None,
            source_evidence_id=None,
            cvss_score=7.5,
            cve_id="CVE-2024-1234",
            extra_metadata=None,
        )

        assert response.source == "trivy"
        assert response.severity == "high"

    def test_finding_list_response_schema(self):
        """Test VulnerabilityFindingListResponse schema."""
        from qerds.api.schemas.admin import (
            VulnerabilityFindingListResponse,
            VulnerabilityFindingResponse,
        )

        finding = VulnerabilityFindingResponse(
            finding_id=uuid.uuid4(),
            created_at=datetime.now(UTC),
            source="trivy",
            external_finding_id="CVE-2024-1234",
            severity="high",
            status="open",
            title="Test vulnerability",
            description=None,
            affected_component="api:latest",
            discovered_at=datetime.now(UTC),
            remediated_at=None,
            remediation_notes=None,
            exception_approved_by=None,
            exception_reason=None,
            exception_expires=None,
            source_evidence_id=None,
            cvss_score=None,
            cve_id=None,
            extra_metadata=None,
        )

        response = VulnerabilityFindingListResponse(
            total=1,
            findings=[finding],
        )

        assert response.total == 1
        assert len(response.findings) == 1

    def test_finding_export_schema(self):
        """Test VulnerabilityFindingExport schema."""
        from qerds.api.schemas.admin import VulnerabilityFindingExport

        export = VulnerabilityFindingExport(
            exported_at=datetime.now(UTC),
            exported_by="admin-123",
            total_findings=10,
            by_severity={"critical": 2, "high": 5, "medium": 3},
            by_status={"open": 7, "remediated": 3},
            by_source={"trivy": 10},
            findings=[],
            export_hash="abc123" * 10 + "abcd",  # 64 char hash
        )

        assert export.total_findings == 10
        assert export.by_severity["critical"] == 2

    def test_bulk_import_response_schema(self):
        """Test VulnerabilityFindingBulkImportResponse schema."""
        from qerds.api.schemas.admin import VulnerabilityFindingBulkImportResponse

        response = VulnerabilityFindingBulkImportResponse(
            imported_count=5,
            skipped_count=2,
            error_count=1,
            findings=[],
            errors=["Finding 3: missing VulnerabilityID"],
        )

        assert response.imported_count == 5
        assert response.skipped_count == 2
        assert len(response.errors) == 1


# -----------------------------------------------------------------------------
# Status Transition Tests
# -----------------------------------------------------------------------------


class TestStatusTransitions:
    """Tests for vulnerability finding status transitions."""

    def test_valid_status_transitions(self):
        """Test valid status transition scenarios."""
        from qerds.db.models.vulnerability import FindingStatus

        # All statuses can be set initially
        for status in FindingStatus:
            assert status.value in [
                "open",
                "in_progress",
                "remediated",
                "excepted",
                "false_positive",
            ]

    def test_remediated_requires_notes_recommendation(self):
        """Test that remediated status should have notes (recommendation)."""
        # This is a business rule test - remediation notes are recommended
        # but not required at the schema level
        update = VulnerabilityFindingUpdate(
            status="remediated",
            remediation_notes="Fixed by upgrading to version 2.0",
        )
        assert update.remediation_notes is not None

    def test_excepted_should_have_reason(self):
        """Test that excepted status should have a reason."""
        # The API enforces this, not the schema
        update = VulnerabilityFindingUpdate(
            status="excepted",
            exception_reason="Risk accepted due to compensating controls",
        )
        assert update.exception_reason is not None


# -----------------------------------------------------------------------------
# Trivy Format Parsing Tests
# -----------------------------------------------------------------------------


class TestTrivyFormatParsing:
    """Tests for parsing Trivy JSON format in bulk import."""

    def test_trivy_severity_mapping(self):
        """Test Trivy severity values map correctly."""
        from qerds.db.models.vulnerability import FindingSeverity

        # Trivy uses uppercase severity values
        trivy_to_internal = {
            "CRITICAL": FindingSeverity.CRITICAL,
            "HIGH": FindingSeverity.HIGH,
            "MEDIUM": FindingSeverity.MEDIUM,
            "LOW": FindingSeverity.LOW,
            "UNKNOWN": FindingSeverity.INFORMATIONAL,
        }

        for trivy_sev, internal_sev in trivy_to_internal.items():
            assert internal_sev.value == trivy_sev.lower() or trivy_sev == "UNKNOWN"

    def test_trivy_finding_structure(self):
        """Test expected Trivy JSON finding structure."""
        # Trivy JSON format reference
        trivy_finding = {
            "VulnerabilityID": "CVE-2024-1234",
            "PkgName": "libssl",
            "InstalledVersion": "1.0.0",
            "FixedVersion": "1.0.1",
            "Severity": "HIGH",
            "Title": "Buffer overflow in libssl",
            "Description": "A buffer overflow vulnerability...",
            "CVSS": {
                "nvd": {"V3Score": 7.5, "V3Vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"},
            },
        }

        # Verify we can extract expected fields
        assert "VulnerabilityID" in trivy_finding
        assert "Severity" in trivy_finding
        assert trivy_finding["CVSS"]["nvd"]["V3Score"] == 7.5


# -----------------------------------------------------------------------------
# Export Hash Tests
# -----------------------------------------------------------------------------


class TestExportHash:
    """Tests for export hash generation."""

    def test_export_hash_is_sha256(self):
        """Test that export hash is valid SHA-256."""
        import hashlib
        import json

        export_data = {
            "exported_at": datetime.now(UTC).isoformat(),
            "exported_by": "test-admin",
            "total_findings": 5,
            "finding_ids": [str(uuid.uuid4()) for _ in range(5)],
        }

        export_hash = hashlib.sha256(json.dumps(export_data, sort_keys=True).encode()).hexdigest()

        # SHA-256 produces 64 hex characters
        assert len(export_hash) == 64
        assert all(c in "0123456789abcdef" for c in export_hash)

    def test_export_hash_deterministic(self):
        """Test that export hash is deterministic for same input."""
        import hashlib
        import json

        export_data = {
            "exported_by": "admin",
            "total_findings": 3,
            "finding_ids": ["id1", "id2", "id3"],
        }

        hash1 = hashlib.sha256(json.dumps(export_data, sort_keys=True).encode()).hexdigest()
        hash2 = hashlib.sha256(json.dumps(export_data, sort_keys=True).encode()).hexdigest()

        assert hash1 == hash2


# -----------------------------------------------------------------------------
# Migration Tests
# -----------------------------------------------------------------------------


class TestMigration:
    """Tests for migration file."""

    def test_migration_revision_chain(self):
        """Test migration revision chain is correct."""
        import importlib

        migration = importlib.import_module(
            "qerds.db.migrations.versions.20260123_000000_004_add_vulnerability_findings_table"
        )

        assert migration.revision == "004"
        assert migration.down_revision == "003"

    def test_migration_has_upgrade_downgrade(self):
        """Test migration has upgrade and downgrade functions."""
        import importlib

        migration = importlib.import_module(
            "qerds.db.migrations.versions.20260123_000000_004_add_vulnerability_findings_table"
        )

        assert hasattr(migration, "upgrade")
        assert hasattr(migration, "downgrade")
        assert callable(migration.upgrade)
        assert callable(migration.downgrade)
